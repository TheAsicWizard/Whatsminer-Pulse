<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hashboard Monitor</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; padding: 20px; }
  .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .header h1 { font-size: 22px; color: #f5a623; font-weight: 700; }
  .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  input { background: #1a1a2e; border: 1px solid #333; color: #e0e0e0; padding: 8px 12px; border-radius: 6px; font-size: 14px; width: 180px; }
  input:focus { outline: none; border-color: #f5a623; }
  button { background: #f5a623; color: #000; border: none; padding: 8px 18px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
  button:hover { background: #e6951f; }
  button.stop { background: #e74c3c; color: #fff; }
  button.stop:hover { background: #c0392b; }
  .status { font-size: 12px; color: #888; margin-left: 8px; }
  .status.connected { color: #2ecc71; }
  .status.error { color: #e74c3c; }
  .miner-info { background: #12121f; border: 1px solid #222; border-radius: 10px; padding: 16px 20px; margin-bottom: 16px; }
  .miner-info h2 { font-size: 16px; color: #ccc; margin-bottom: 10px; }
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
  .summary-item { background: #1a1a2e; border: 1px solid #282840; border-radius: 8px; padding: 10px 14px; }
  .summary-item .label { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
  .summary-item .value { font-size: 18px; font-weight: 700; color: #fff; margin-top: 2px; font-family: 'Consolas', monospace; }
  .summary-item .value.small { font-size: 13px; }
  .boards { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; margin-top: 16px; }
  .board-card { background: #12121f; border: 1px solid #222; border-radius: 10px; padding: 16px 20px; transition: border-color 0.3s; }
  .board-card.healthy { border-color: #2ecc71; }
  .board-card.warning { border-color: #f5a623; }
  .board-card.critical { border-color: #e74c3c; }
  .board-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .board-name { font-size: 18px; font-weight: 700; }
  .board-status { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 600; }
  .board-status.healthy { background: rgba(46,204,113,0.15); color: #2ecc71; }
  .board-status.warning { background: rgba(245,166,35,0.15); color: #f5a623; }
  .board-status.critical { background: rgba(231,76,60,0.15); color: #e74c3c; }
  .board-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .board-stat .label { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
  .board-stat .value { font-size: 16px; font-weight: 600; color: #fff; font-family: 'Consolas', monospace; }
  .board-meta { margin-top: 10px; padding-top: 10px; border-top: 1px solid #1e1e35; }
  .board-meta-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; }
  .board-meta-row .label { font-size: 10px; text-transform: uppercase; color: #666; }
  .board-meta-row .value { font-size: 12px; color: #aaa; font-family: 'Consolas', monospace; }
  .temp-bar { height: 4px; background: #222; border-radius: 2px; margin-top: 12px; overflow: hidden; }
  .temp-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; }
  .log { background: #0d0d18; border: 1px solid #1a1a2e; border-radius: 8px; padding: 12px; margin-top: 16px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; color: #666; }
  .log .entry { padding: 2px 0; }
  .log .entry.error { color: #e74c3c; }
  .log .entry.ok { color: #2ecc71; }
  .interval-select { background: #1a1a2e; border: 1px solid #333; color: #e0e0e0; padding: 8px; border-radius: 6px; font-size: 14px; }
  .raw-section { margin-top: 16px; }
  .raw-toggle { background: #1a1a2e; border: 1px solid #333; color: #888; padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; }
  .raw-toggle:hover { color: #e0e0e0; border-color: #555; }
  .raw-data { display: none; background: #0d0d18; border: 1px solid #1a1a2e; border-radius: 8px; padding: 12px; margin-top: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 11px; color: #888; white-space: pre-wrap; word-break: break-all; }
</style>
</head>
<body>

<div class="header">
  <h1>Hashboard Monitor</h1>
  <div class="controls">
    <input type="text" id="ip" placeholder="Miner IP" value="10.31.172.196">
    <input type="text" id="port" placeholder="Port" value="4028" style="width:80px">
    <select id="interval" class="interval-select">
      <option value="3">3s</option>
      <option value="5" selected>5s</option>
      <option value="10">10s</option>
      <option value="30">30s</option>
    </select>
    <button id="startBtn" onclick="togglePoll()">Start</button>
    <span id="status" class="status">Not connected</span>
  </div>
</div>

<div id="minerInfoSection" class="miner-info" style="display:none">
  <h2>Miner Info</h2>
  <div id="minerInfoGrid" class="summary-grid"></div>
</div>

<div id="summarySection" class="miner-info" style="display:none">
  <h2>Miner Summary</h2>
  <div id="summaryGrid" class="summary-grid"></div>
</div>

<div id="boardsContainer" class="boards"></div>

<div class="raw-section">
  <button class="raw-toggle" onclick="toggleRaw()">Show Raw JSON</button>
  <div id="rawData" class="raw-data"></div>
</div>

<div id="logBox" class="log"></div>

<script>
let polling = false;
let timer = null;
let pollCount = 0;
let lastRawData = {};

function addLog(msg, type = '') {
  const box = document.getElementById('logBox');
  const entry = document.createElement('div');
  entry.className = 'entry ' + type;
  entry.textContent = new Date().toLocaleTimeString() + ' ' + msg;
  box.prepend(entry);
  if (box.children.length > 100) box.removeChild(box.lastChild);
}

function toggleRaw() {
  const el = document.getElementById('rawData');
  if (el.style.display === 'block') {
    el.style.display = 'none';
  } else {
    el.style.display = 'block';
    el.textContent = JSON.stringify(lastRawData, null, 2);
  }
}

function togglePoll() {
  if (polling) {
    polling = false;
    clearTimeout(timer);
    document.getElementById('startBtn').textContent = 'Start';
    document.getElementById('startBtn').className = '';
    document.getElementById('status').textContent = 'Stopped';
    document.getElementById('status').className = 'status';
    addLog('Polling stopped');
  } else {
    polling = true;
    pollCount = 0;
    document.getElementById('startBtn').textContent = 'Stop';
    document.getElementById('startBtn').className = 'stop';
    addLog('Polling started');
    doPoll();
  }
}

async function doPoll() {
  if (!polling) return;
  const ip = document.getElementById('ip').value;
  const port = document.getElementById('port').value;
  const interval = parseInt(document.getElementById('interval').value) * 1000;

  document.getElementById('status').textContent = 'Polling...';
  document.getElementById('status').className = 'status connected';

  try {
    const [summary, devs, devdetails, minerInfo] = await Promise.all([
      queryMiner(ip, port, 'summary'),
      queryMiner(ip, port, 'edevs'),
      queryMiner(ip, port, 'devdetails').catch(() => null),
      pollCount === 0 ? queryMiner(ip, port, 'get_miner_info').catch(() => null) : Promise.resolve(null)
    ]);

    pollCount++;
    lastRawData = { summary, edevs: devs, devdetails, get_miner_info: minerInfo };

    if (minerInfo) renderMinerInfo(minerInfo);
    renderSummary(summary);
    renderBoards(devs, devdetails);
    addLog('Poll #' + pollCount + ' OK - ' + (devs.DEVS||[]).length + ' boards', 'ok');
    document.getElementById('status').textContent = 'Connected - Poll #' + pollCount;

    const rawEl = document.getElementById('rawData');
    if (rawEl.style.display === 'block') {
      rawEl.textContent = JSON.stringify(lastRawData, null, 2);
    }
  } catch (err) {
    addLog('Error: ' + err.message, 'error');
    document.getElementById('status').textContent = 'Error: ' + err.message;
    document.getElementById('status').className = 'status error';
  }

  if (polling) timer = setTimeout(doPoll, interval);
}

let proxyPort = 3939;

function queryMiner(ip, port, command) {
  return fetch('http://localhost:' + proxyPort + '/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ip, port: parseInt(port), command })
  }).then(r => {
    if (!r.ok) return r.text().then(t => { throw new Error(t); });
    return r.json();
  });
}

function renderMinerInfo(data) {
  const info = data?.Msg || data?.msg || data;
  if (!info || typeof info !== 'object') return;

  const section = document.getElementById('minerInfoSection');
  section.style.display = 'block';

  const items = [
    { label: 'Model', value: info.miner_type || info.minertype || info.Model || '-' },
    { label: 'Firmware', value: info.fw_ver || info.firmware || '-' },
    { label: 'Compile Time', value: info.CompileTime || info.compile_time || '-' },
    { label: 'MAC', value: info.mac || info.Mac || '-' },
    { label: 'IP', value: info.ip || info.Ip || document.getElementById('ip').value },
    { label: 'Serial', value: info.sn || info.Serial || '-' },
    { label: 'Network Type', value: info.nettype || info.net_type || '-' },
    { label: 'DNS', value: info.dns || info.Dns || '-' },
  ];

  document.getElementById('minerInfoGrid').innerHTML = items
    .filter(i => i.value && i.value !== '-')
    .map(i => '<div class="summary-item"><div class="label">' + i.label + '</div><div class="value small">' + i.value + '</div></div>').join('');
}

function renderSummary(data) {
  const s = data?.SUMMARY?.[0] || data?.Msg || {};
  const section = document.getElementById('summarySection');
  section.style.display = 'block';
  const grid = document.getElementById('summaryGrid');

  const ghsAv = s['GHS av'] || 0;
  const mhsAv = s['MHS av'] || 0;
  let hashrate;
  if (ghsAv > 0) {
    hashrate = (ghsAv / 1000).toFixed(2) + ' TH/s';
  } else if (mhsAv > 0) {
    hashrate = (mhsAv / 1e6).toFixed(2) + ' TH/s';
  } else {
    hashrate = '0.00 TH/s';
  }

  const items = [
    { label: 'Hashrate', value: hashrate },
    { label: 'Temperature', value: (s.Temperature || '-') + ' C' },
    { label: 'Power', value: (s.Power || s['Power Consumption'] || '-') + ' W' },
    { label: 'Fan In', value: (s['Fan Speed In'] || s.FanSpeedIn || '-') + ' RPM' },
    { label: 'Fan Out', value: (s['Fan Speed Out'] || s.FanSpeedOut || '-') + ' RPM' },
    { label: 'Accepted', value: (s.Accepted || 0).toLocaleString() },
    { label: 'Rejected', value: (s.Rejected || 0).toLocaleString() },
    { label: 'HW Errors', value: (s['Hardware Errors'] || s.HardwareErrors || 0).toLocaleString() },
    { label: 'Uptime', value: formatUptime(s.Elapsed || 0) },
    { label: 'Power Mode', value: s['Power Mode'] || '-' },
    { label: 'Factory GH/s', value: ((s['Factory GHS'] || 0) / 1000).toFixed(0) + ' TH/s' },
    { label: 'Env Temp', value: (s['Env Temp'] || s.env_temp || '-') + ' C' },
  ];

  grid.innerHTML = items.map(i => '<div class="summary-item"><div class="label">' + i.label + '</div><div class="value">' + i.value + '</div></div>').join('');
}

function renderBoards(data, detailsData) {
  const boards = data?.DEVS || [];
  const details = detailsData?.DEVDETAILS || [];
  const container = document.getElementById('boardsContainer');

  container.innerHTML = boards.map((b, i) => {
    const temp = b.Temperature || 0;
    const status = temp > 80 ? 'critical' : temp > 65 ? 'warning' : 'healthy';
    const statusLabel = temp > 80 ? 'CRITICAL' : temp > 65 ? 'WARNING' : 'HEALTHY';
    const hsGH = (b['MHS av'] || 0) / 1000;
    const hsRT = (b['HS RT'] || b['MHS 1m'] || 0) / 1000;
    const hs15m = (b['MHS 15m'] || 0) / 1000;
    const factoryTH = ((b['Factory GHS'] || 0) / 1000).toFixed(1);
    const chips = b['Effective Chips'] || '-';
    const freq = b['Chip Frequency'] || '-';
    const upfreq = b['Upfreq Complete'] || 0;
    const chipData = b['Chip Data'] || '-';
    const pcbSN = b['PCB SN'] || '';
    const tempPct = Math.min(100, (temp / 100) * 100);
    const tempColor = temp > 80 ? '#e74c3c' : temp > 65 ? '#f5a623' : '#2ecc71';

    const detail = details.find(d => d.Slot === b.Slot) || {};
    const driver = detail.Driver || '-';
    const model = detail.Model || detail.Name || '-';

    let chipType = '-';
    if (chipData && chipData !== '-') {
      chipType = chipData;
    }

    return '<div class="board-card ' + status + '">' +
      '<div class="board-header">' +
        '<span class="board-name">SM' + (b.Slot ?? i) + '</span>' +
        '<span class="board-status ' + status + '">' + statusLabel + '</span>' +
      '</div>' +
      '<div class="board-stats">' +
        '<div class="board-stat"><div class="label">Temperature</div><div class="value">' + temp.toFixed(1) + ' C</div></div>' +
        '<div class="board-stat"><div class="label">Frequency</div><div class="value">' + freq + ' MHz</div></div>' +
        '<div class="board-stat"><div class="label">Hashrate (avg)</div><div class="value">' + hsGH.toFixed(2) + ' GH/s</div></div>' +
        '<div class="board-stat"><div class="label">Hashrate (RT)</div><div class="value">' + hsRT.toFixed(2) + ' GH/s</div></div>' +
        '<div class="board-stat"><div class="label">Hashrate (15m)</div><div class="value">' + hs15m.toFixed(2) + ' GH/s</div></div>' +
        '<div class="board-stat"><div class="label">Factory GH/s</div><div class="value">' + factoryTH + ' TH/s</div></div>' +
        '<div class="board-stat"><div class="label">Eff. Chips</div><div class="value">' + chips + '</div></div>' +
        '<div class="board-stat"><div class="label">Upfreq Done</div><div class="value">' + (upfreq ? 'Yes' : 'No') + '</div></div>' +
      '</div>' +
      '<div class="board-meta">' +
        '<div class="board-meta-row"><span class="label">Chip Data</span><span class="value">' + chipType + '</span></div>' +
        '<div class="board-meta-row"><span class="label">PCB S/N</span><span class="value">' + pcbSN + '</span></div>' +
        (model !== '-' ? '<div class="board-meta-row"><span class="label">Model</span><span class="value">' + model + '</span></div>' : '') +
        (driver !== '-' ? '<div class="board-meta-row"><span class="label">Driver</span><span class="value">' + driver + '</span></div>' : '') +
      '</div>' +
      '<div class="temp-bar"><div class="temp-bar-fill" style="width:' + tempPct + '%;background:' + tempColor + '"></div></div>' +
    '</div>';
  }).join('');
}

function formatUptime(seconds) {
  const d = Math.floor(seconds / 86400);
  const h = Math.floor((seconds % 86400) / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  return d > 0 ? d + 'd ' + h + 'h ' + m + 'm' : h + 'h ' + m + 'm';
}

document.getElementById('status').textContent = 'Ready - proxy on port ' + proxyPort;
addLog('Hashboard Monitor ready. Proxy must be running on port ' + proxyPort);
addLog('Start proxy: node hashboard-proxy.js');
</script>
</body>
</html>
